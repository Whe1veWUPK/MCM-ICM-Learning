# 时间序列模型
将预测对象按照**时间顺序**排列起来，构成一个所谓的时间序列，从所构成的这一组时间序列过去的变化规律，推断**今后变化的可能性**以及**变化趋势**、**变化规律**，这就是时间序列预测法


时间序列模型其实是一种**回归模型**，其基于的原理是：
* 一方面承认事物发展的延续性，运用过去时间序列的数据进行统计分析就能推测事物的发展趋势
* 另一方面充分考虑到偶然因素影响而产生的随机性，为了消除随机波动的影响，利用历史数据，进行统计分析，并对数据进行适当的处理，进行趋势预测


## 确定性时间序列分析定义
***时间序列预测技术就是通过对预测目标自身时间序列的处理，来研究其变化趋势。***


一个时间序列往往是以下几类变化形式的叠加或耦合：
* **长期趋势变动**: 它是指时间序列朝着一定的方向持续上升或下降，或停留在某一水平上的倾向。也就是客观事物的**主要变化趋势**
* **季节变动**：序列的数据受到季节性的影响
* **循环变动**： 通常是指周期为一年以上，由非季节因素引起的涨落起伏波形相似的波动
* **不规则变动**： 通常分为**突然变动**或**随机变动**

通常用```Tt```表示长期趋势项，```St```表示季节变动趋势项，```Ct```表示循环变动趋势项，```Rt```表示随机干扰项。常见的时间序列模型:
* **加性模型**：

$$y_t=T_t+S_t+C_t+R_t$$
* **乘性模型**：

$$y_t=T_t*S_t*C_t*R_t$$
* **混合模型**：

$$y_t=T_t*S_t+R_t$$
$$y_t=S_t+T_t*C_t*R_t$$


在上述的式子中，$y_t$ 是观测目标的观察记录（也就是已知数据），均值$E(R_t)=0$,方差$Var(R_t)=\sigma^2$

也就是我们已知时间点```t```的数据$y_t$，然后去求解$y_t$的组成部分，即$T_t$，$S_t$，$C_t$，$R_t$


如果在预测时间范围以内，无**突然变动**且**随机变动**的方差$\sigma^2$较小，并且有理由认为**过去和现在的演变趋势**（找到的$T_t$等规律）将**继续发展到未来**时，可用一些经验方法进行预测


## 具体的方法
### 移动平均法
设观测序列为$y_1,\cdots,y_T$，取移动平均的项数 $N<T$，一次移动平均值的计算公式为

$$
\begin{align}
M_t^{(1)}&=\frac{1}{N}(y_t+y_{t-1}+\cdots+y_{t-N+1}) \notag\\
&=\frac{1}{N}(y_{t-1}+\cdots+y_{t-N})+\frac{1}{N}(y_t-y_{t-N})=M_{t-1}^{(1)}+\frac{1}{N}(y_t-y_N) \notag
\end{align}
$$
二次移动平均值计算公式为

$$M_t^{(2)}=\frac{1}{N}(M_t^{(1)}+\cdots+M_{t-N+1}^{(1)})=M_{t-1}^{(2)}+\frac{1}{N}(M_t^{(1)}-M_{t-N}^{(1)})$$


当我们的预测目标的数据的基本趋势是**在某一水平上下波动时**，可用**一次移动平均方法**建立预测模型
$$\hat{y}_{t+1}=M_t^{(1)}=\frac{1}{N}(y_t+\cdots+y_{t-N+1}), t = N, N+1, \cdots, T,$$

那么它的标准误差是
$$S=\sqrt{\frac{\sum\limits_{t=N+1}^T(\hat{y}_t-y_t)^2}{T-N}}$$

最近$N$期序列值的平均值作为未来各期的预测结果。一般 $N$ 取值范围:$5\leq N \leq 200$

当历史序列的**基本趋势变化不大**且**序列中随机变动成分较多**时， $N$ 的取值应该较大一些，否则 $N$ 的取值应该较小一些

在确定的**季节变动周期**的资料中，移动平均的项数应该取周期长度


总体来说，$N$ 的选取可以，比较其预测标准误差$S$，取预测标准误差最小者的 $N$

当预测目标的基本趋势与某一**线性模型**相吻合时，常用**二次移动平均法**，但序列同时存在线性趋势与周期波动时，可用**趋势移动平均法**建立预测模型，如下:
$$\hat{y}_{T+m}=a_T+b_Tm, m = 1, 2, \cdots$$
上述式子中的:
$$a_T=2M_T^{(1)}-M_T^{(2)};b_T=\frac{2}{N-1}(M_T^{(1)}-M_T^{(2)})$$


***移动平均法主要用于数据平滑处理，是一种非常简单的时间序列分析方法。主要用于消除数据中的随机波动，更清楚的展现数据的趋势（长期方向）和季节性（周期性波动）***

***在移动平均法中，通常是不会直接分解出上述提到的模型中的四种分量$T_t，S_t，C_t，R_t$。它实际上是对 $y_t$ 整体的估计，不会单独的分析每一个分量***

### 指数平滑法
一次移动平均实际上认为**最近 $N$ 期数据对未来的影响相同**，都加权 $1/N$ ，而 **$N$ 期以前的数据对未来值没有影响**

但是，二次以及更高次移动平均的权数却不是 $1/N$ ，且次数越高，权数越复杂，但永远保证**对称**的权数（两端权数小，中间权数大），这不符合一般系统动态性（**移动平均法的问题**）。

一般说来，历史数据对未来值的影响应该**随时间间隔的增长和递减**，指数平滑法就满足这个要求

***指数平滑法根据平滑次数的不同可以分为一次指数平滑法、二次指数平滑法以及三次指数平滑法***
#### 一次指数平滑法
1. 预测模型
设时间序列为$y_1,y_2,\cdots,y_t,\cdots,\alpha$ 为加权系数，$0 \lt \alpha \lt 1$，一次指数平滑公式为
$$S_t^{(1)}=\alpha y_t+(1-\alpha)S_{t-1}^{(1)}$$
***这个地方应该很熟悉，计网里面预测RTT是用到的，操作系统里进程调度时预测分配给进程的CPU时间也用到了***
这里的加权指的是**加权系数**呈指数分布
预测模型为:
$$\hat{y}_{t+1}=S_t^{(1)}$$
也就是:
$$\hat{y}_{t+1}=\alpha y_t+(1-\alpha) \hat{y}_t$$
第```t```期指数平滑值，作为第```t+1```期的预测值
2. 加权系数 $\alpha$ 的选择
遵循如下原则：
 * 如果时间序列波动不大，比较平稳，那么 $\alpha$ 应小一点，如0.1~0.5
 * 如果时间序列具有迅速且明显的变动倾向，那么 $\alpha$ 应大一点， 如 0.6~0.8
 * 当然，实际上也可以多取几个值进行试算，哪个预测误差小，就取哪个



3.  初始值的确定
有如下规则:
* 时间序列数据较多，在20个以上时，可选用第一个数值作为初始值 $s_0$
* 时间序列较少时，一般取最初几期实际值的平均值作为初始值



#### 二次指数平滑法
计算公式
$$
\begin{cases}
S_t^{(1)}=\alpha y_t +(1-\alpha) S_{t-1}^{(1)} \\
S_t^{(2)}=\alpha S_t^{(1)}+(1-\alpha) S_{t-1}^{(2)}
\end{cases}
$$
其中, $S_t^{(1)}$ 为一次指数平滑值，$S_t^{(2)}$ 为二次指数平滑值

当时间序列 ${y_t}$ 从某时期开始具有直线趋势时，可用直线趋势模型进行预测
$$\hat{y}_{t+m}=a_t+b_tm, m = 1, 2, \cdots \\
\begin{cases}
a_t=2S_t^{(1)}-S_t^{(2)}\\
b_t=\frac{\alpha}{1-\alpha}(S_t^{(1)}-S_t^{(2)})
\end{cases}$$


#### 三次指数平滑法
当时间序列的变动表现为**二次曲线**趋势时，则需要用**三次指数平滑法**

计算公式:
$$
\begin{cases}
S_t^{(1)}=\alpha y_t +(1-\alpha) S_{t-1}^{(1)} \\
S_t^{(2)}=\alpha S_t^{(1)}+(1-\alpha) S_{t-1}^{(2)} \\
S_t^{(3)}=\alpha S_t^{(2)}+(1-\alpha) S_{t-1}^{(3)}
\end{cases}
$$
$S_t^{(3)}$ 为三次指数平滑值

三次指数平滑法的预测模型为:
$$
\hat{y}_{t+m}=a_t+b_tm+c_tm^2, m = 1, 2, \cdots
$$
式中：
$$
\begin{cases}
a_t=3S_t^{(1)}-3S_t^{(2)}+S_t^{(3)}\\
b_t=\frac{\alpha}{2(1-\alpha)^2}[(6-5\alpha)S_t^{(1)}-2(5-4\alpha)S_t^{(2)}+(4-3\alpha)S_t^{(3)}]\\
c_t=\frac{\alpha ^2}{2(1-\alpha)^2}[S_t^{(1)}-2S_t^{(2)}+S_t^{(3)}]
\end{cases}$$

***差分指数平滑法很类似，普通的K阶指数平滑法是预测K-1次的曲线的，但是K阶差分指数平滑法可用预测K次曲线（因为取的是差分预测，差分可近似为求导（对曲线进行求导降低一阶））***

### 具有季节性特点的时间序列预测

在不少实际问题中，时间序列有很明显的周期规律性，如气温、雨量、用电量等

***由季节性因素或其他周期因素引起的周期性变化的时间序列，称为季节性时间序列***


#### 计算步骤

***对于季节性时间序列的预测，要从数学上完全拟合其变化曲线是非常困难的。但预测的目的是为了找到时间序列的变化趋势，尽可能的做到精确，下面就介绍一种季节系数法***


1. 收集```m```年的每年各个季度或者各月份（每年```n```个季度）的时间序列样本数据 $a_{ij}$ 。 其中 $i$ 表示年份的序号($i=1,2,\cdots,m$)，$j$ 表示季度或者月份的序号($j=1,2,\cdots,n$)

2. 计算每年所有季度或所有月份的算数平均值 $\bar a$
$$\bar a = \frac{1}{k}\sum\limits_{i=1}^m\sum\limits_{j=1}^{n}a_{ij},k=mn$$

3. 计算同季度或同月份的数据的算术平均值 $\bar a_{\cdot j}=\frac{1}{m}\sum\limits_{i=1}^m,j=1,2,\cdots,n$

4. 计算季度系数或月份系数 $b_j=\frac{\bar a_{\cdot j}}{\bar a}$

5. 预测计算。当时间序列是按照季度列出时，先求出预测年份（下一年）的年加权平均
$$y_{m+1}=\frac{\sum\limits_{i=1}^mw_iy_i}{\sum\limits_{i=1}^{m}w_i}$$
式中: $y_i=\sum\limits_{j=1}^ma_{ij}$ 为第```i```年的年合计数， $w_i$ 为第```i```年的权数，按自然序列取值，即 $w_i=i$
再计算预测年份的季度平均值 $\bar y_{m+1}= y_{m+1}/n$ 。 最后，预测年份第```j```季度的预测值为:
$$y_{m+1,j}=b_j \bar y_{m+1}$$


## 平稳时间序列模型
接下来介绍另外一类时间序列模型（不同于确定性时间模型）

平稳指的是宽平稳，特性是序列的统计特性**不随时间的平移而变化**，即**均值和协方差**不随时间的平移而变化


均值的定义和概率论与数理统计中一样

这里列出自协方差的定义:
对随机过程{ $X_t, t \in T$ } 取定 $t,s \in T$ ，定义其自协方差函数为:
$$\gamma_{t,s}=Cov(X_t,X_s)=E[(X_t-
\mu_t)(X_s-\mu_s)]$$



### 模型定义
***那么具体什么样的序列是平稳时间序列呢？***

设随机序列 { $ X_t,t=0,\pm1,\pm2,\cdots$ } 满足
* $E(X_t)=\mu= 常数$
* $\gamma_{t+k,t}=\gamma_k(k=0,\pm1,\pm2,\cdots)$ 与 ```t```无关

则称该序列是平稳时间序列

### 典型模型
#### AR(Auto Regressive) 模型 （自回归模型）


设 { $X_t, t=0,\pm1,\pm2,\cdots$}是零均值平稳序列，满足下列模型
$$X_t=\phi_1X_{t-1}+\phi_2X_{t-2}+\cdots+\phi_pX_{t-p}+\epsilon_t$$

式中： $\epsilon_t$ 是零均值，方程为 $\sigma_{\epsilon}^2$的白噪声，$X_t$ 就是阶数为```p```的自回归序列，简记为```AR(p)```,其中 $\phi$ 是回归参数（如何求？**最小二乘法**）


#### MA(Moveing Average) 模型 （移动平均模型）
设 { $X_t, t=0,\pm1,\pm2,\cdots$}是零均值平稳序列，满足下列模型
$$X_t=\epsilon_t-\theta_1\epsilon_{t-1}-\theta_2\epsilon_{t-2}-\cdots-\theta_q\epsilon_{t-q}$$

式中： $\epsilon_t$ 是零均值，方程为 $\sigma_{\epsilon}^2$的白噪声，$X_t$ 就是阶数为```q```的移动平均序列，简记为```MA(q)```,其中 $\pmb\theta$ 是平均参数向量（如何求？**最小二乘法**）


***这里可以观察到移动平均序列是基于前段时间的白噪声进行估值的，而自回归序列则是根据前端时间的实际值进行估值的***


#### ARMA 模型 （自回归移动平均模型）
设 { $X_t, t=0,\pm1,\pm2,\cdots$}是零均值平稳序列，满足下列模型
$$X_t-\phi_1X_{t-1}-\phi_2X_{t-2}-\cdots-\phi_pX_{t-p}=\epsilon_t-\theta_1\epsilon_{t-1}-\theta_2\epsilon_{t-2}-\cdots-\theta_q\epsilon_{t-q}$$

式中： $\epsilon_t$ 是零均值，方程为 $\sigma_{\epsilon}^2$的白噪声，$X_t$ 就是阶数为```p,q```的自回归移动平均序列，简记为```ARMA(p,q)```



### 建模过程及预测
1. ```ARMA```模型的构建
* ARMA的定阶，```Akaike```定阶准则：
  选定```p```, ```q```使得
  $$min AIC = n\ln \hat \sigma_{\epsilon}^2+2(p+q+1)$$
  其中: ```n``` 为样本容量，$\hat \sigma_{\epsilon}^2$ 是对 $\sigma_{\epsilon}^2$ 的估计，与 ```p``` 和 ```q``` 有关。若当 $p=\hat p $， $q=\hat q$式，上式达到最小值，则认为该序列是 $ARMA(\hat p, \hat q)$

* ```ARMA```的参数估计

* ```ARMA```模型检验

  
```ARMA.py```里有示例，最终输出的结果也包含残差检验的结果

2. ```ARMA```模型的预测
根据上面的阶数以及参数的估计值，使用递推即可推得预测值（阶数已知，参数已知（第一步模型已经进行了参数估计））


## 差分时间序列模型（ARIMA）
实际遇到的时间序列往往有三个特性：趋势性、季节性与非平稳性。
通常采用**差分方法**，消除其**趋势性**、**季节性**，使得变换后的序列是**平稳序列**，然后再假设其为```ARMA```序列，再采用上述方法去研究

***怎样理解呢？***
比如说原先的数据是一个线性规律的数据（我们对其进行一阶差分后就让其变为了一个**平稳序列**（直线求导是常数））

模型的构建方法与```ARMA```模型的构建方法一致，这里就不在赘述，在```ARMA.py```中，实际用的是```ARIMA```函数，让```d```取```0```,也就是不求差分，即是我们想要的```ARMA```模型


## 模型优点
* **能够处理非平稳数据**：使用```ARIMA```模型
* **发现隐含模式**: 揭示数据中的趋势（主要体现在参数方面，我们评估的参数实际上就是数据的趋势）
* **强大的短期预测能力**： 对于具有明显时间依赖性的数据，时间序列分析提供了准确的短期预测
## 模型缺点
* **依赖历史数据**： 模型的准确性高度依赖于历史数据的质量以及数量
* **长期预测准确性较低**： 随着时间的延长，误差或者说噪声会不断的累积增大
* **模型选择和调整复杂**： 定出模型的阶数以及参数，需要长时间的计算以及专业知识，就算已经给出了阶数，计算时间依旧很长（```ARMA.py```的计算时间是很长的）
* **无法解释因果关系**： 时间序列更多关注模式和趋势的发现，而不是因果关系的解释



## 与其它模型的比较
1. 微分方程模型
* 微分方程模型通常基于物理法则或其他科学理论
* 适合于描述连续变化的系统
* 用于解释系统的内在动力学和因果关系（公式可以解释因果关系）
2. 差分方程模型
* 适用于离散时间数据
* 描述具有递推关系的系统
* 在处理非线性系统时更灵活（```ARIMA```模型还要选取差分阶数进行平稳化处理）
3. 灰色预测模型
* 用于数据信息不完全的情况，特别是数据量较少
* 侧重于揭示系统的发展趋势
* 通常用于中短期预测，并且在处理不确定性和模糊数据方面有优势


时间序列分析尤其适用于具有明显**时间依赖性**以及**周期性**的数据。适用于短期预测，处理长期预测以及非历史依赖的因果关系时不如基于理论的模型（微分方程模型）有效
